<!doctype html>
<html lang="tr">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Rüyanı Gönder | DreamOracle</title>
  <link rel="icon" href="/favicon.svg" />
  <style>
    :root{
      --bg:#0b1220; --card:#0f1b2d; --muted:#9fb3c8; --text:#e6f1ff; --brand:#57c1ff; --ok:#22c55e; --warn:#f59e0b; --err:#ef4444;
    }
    *{box-sizing:border-box}
    body{margin:0;background:var(--bg);color:var(--text);font:16px/1.6 system-ui,-apple-system,Segoe UI,Roboto,Inter,Ubuntu,"Helvetica Neue",Arial}
    a{color:var(--brand);text-decoration:none}
    .wrap{max-width:960px;margin:40px auto;padding:0 20px}
    .panel{background:var(--card);border:1px solid rgba(255,255,255,.06);border-radius:16px;padding:24px}
    h1{margin:0 0 12px;font-weight:700}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:14px}
    label{display:block;margin:10px 0 6px;color:var(--muted)}
    input,select,textarea{width:100%;background:#091120;border:1px solid #2a3a54;color:var(--text);border-radius:12px;padding:12px 14px}
    textarea{min-height:140px;resize:vertical}
    .actions{margin-top:16px;display:flex;gap:12px;align-items:center}
    .btn{background:var(--brand);color:#001018;border:0;border-radius:12px;padding:12px 16px;cursor:pointer;font-weight:600}
    .hint{font-size:.95rem;color:var(--muted)}
    .grid{display:grid;grid-template-columns:1fr 360px;gap:16px}
    .note{margin-top:14px;border-radius:12px;padding:12px 14px;border:1px solid;display:none}
    .note.ok{display:block;background:#062411;border-color:#134e1f;color:#b7f7c7}
    .note.err{display:block;background:#2a0e12;border-color:#7f1d1d;color:#fecaca}
    .tagline{font-size:.9rem;color:var(--muted);margin:-6px 0 18px}
    @media (max-width:980px){.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <div class="wrap">
    <a href="/"><strong>← DreamOracle</strong></a>
    <h1>Rüyanı Gönder</h1>
    <p class="tagline">Formu doldur, 24 saat içinde e-postana yanıt gelsin. URL’den geldiysen kategori/paket alanlarını senin için seçtik.</p>

    <div class="grid">
      <form id="dreamForm" class="panel" autocomplete="on">
        <div class="row">
          <div>
            <label for="name">Ad Soyad</label>
            <input id="name" name="name" placeholder="Adın Soyadın" required />
          </div>
          <div>
            <label for="email">E-posta</label>
            <input id="email" name="email" type="email" placeholder="eposta@ornek.com" required />
          </div>
        </div>

        <div class="row">
          <div>
            <label for="paket">Paket</label>
            <select id="paket" name="paket">
              <option value="standart">Standart (Ücretsiz)</option>
              <option value="premium">Premium + Koçluk</option>
              <option value="mistik">Tarot / Kahve / Yıldız</option>
            </select>
          </div>
          <div>
            <label for="priority">Öncelik</label>
            <select id="priority" name="priority">
              <option value="genel">Genel yorum</option>
              <option value="is">İş / kariyer</option>
              <option value="iliski">İlişki / aile</option>
              <option value="saglik">Sağlık / enerji</option>
            </select>
          </div>
        </div>

        <div>
          <label for="kategori">Kategori (isteğe bağlı)</label>
          <select id="kategori" name="kategori">
            <option value="">—</option>
            <option value="ruya">Rüya yorumu</option>
            <option value="tarot">Tarot</option>
            <option value="kahve">Kahve</option>
            <option value="yildiz">Yıldız</option>
            <option value="kocluk">Yaşam koçluğu</option>
          </select>
        </div>

        <div style="margin-top:12px">
          <label for="message">Rüyanız</label>
          <textarea id="message" name="message" placeholder="Rüyanı mümkün olduğunca detaylı yaz. Yer, kişiler, hissettiklerin, tekrar eden semboller…"
            required></textarea>
        </div>

        <div class="actions">
          <button class="btn" type="submit">Gönder →</button>
          <span id="labelPill" class="hint"></span>
        </div>

        <div id="noteOk"  class="note ok">Rüyan ulaştı — e-postanı kontrol edebilirsin. ✨</div>
        <div id="noteErr" class="note err">Bir şeyler ters gitti. Lütfen birazdan tekrar dene.</div>
      </form>

      <aside class="panel">
        <h3>İpuçları</h3>
        <p class="hint">Tekrarlayan semboller, güçlü duygular ve “uyandıktan sonra aklımda kalan”
          sahneler çok yardımcı olur. 3–5 madde ile küçük aksiyon listesi çıkar.</p>
        <ul class="hint">
          <li>Standartta 24 saat içinde e-posta alırsın.</li>
          <li>Premium’da kısa koçluk zinciri + gün içi mikro plan.</li>
          <li>Mistik (tarot/kahve/yıldız) isteklerinde “kategori” alanını işaretle.</li>
        </ul>
      </aside>
    </div>
  </div>

  <script>
    const $ = s => document.querySelector(s);
    const params = new URLSearchParams(location.search);
    const map = (v, dict, dft) => dict[v] ?? dft;

    const paketQS    = (params.get('paket')    || '').toLowerCase();
    const kategoriQS = (params.get('kategori') || '').toLowerCase();
    const priorityQS = (params.get('oncelik')  || '').toLowerCase();

    $('#paket').value    = map(paketQS,    {standart:'standart', premium:'premium', mistik:'mistik'}, 'standart');
    $('#kategori').value = map(kategoriQS, {ruya:'ruya', tarot:'tarot', kahve:'kahve', yildiz:'yildiz', kocluk:'kocluk'}, '');
    $('#priority').value = map(priorityQS, {genel:'genel', is:'is', iliski:'iliski', saglik:'saglik'}, 'genel');

    const pill = $('#labelPill');
    const pillParts = [];
    if (paketQS)    pillParts.push(`paket: ${paketQS}`);
    if (kategoriQS) pillParts.push(`kategori: ${kategoriQS}`);
    if (pillParts.length) pill.textContent = pillParts.join(' • ');

    const API_URL = '/api/send-email';

    $('#dreamForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      $('#noteOk').style.display = 'none';
      $('#noteErr').style.display = 'none';

      const payload = {
        name:    $('#name').value.trim(),
        email:   $('#email').value.trim(),
        paket:   $('#paket').value,
        kategori:$('#kategori').value || undefined,
        priority:$('#priority').value,
        message: $('#message').value.trim()
      };

      try {
        const r = await fetch(API_URL, {
          method: 'POST',
          headers: { 'Content-Type':'application/json' },
          body: JSON.stringify(payload)
        });

        const text = await r.text();
        let data; try { data = JSON.parse(text); } catch { data = { raw:text }; }

        if (!r.ok || data?.ok === false) {
          $('#noteErr').textContent = `Hata: ${data?.error || ('HTTP ' + r.status)}${data?.relay?.raw ? ' — ' + data.relay.raw : ''}`;
          $('#noteErr').style.display = 'block';
          return;
        }

        $('#noteOk').style.display = 'block';
        $('#dreamForm').reset();
        // URL ön-seçimlerini koru
        $('#paket').value    = map(paketQS,    {standart:'standart', premium:'premium', mistik:'mistik'}, 'standart');
        $('#kategori').value = map(kategoriQS, {ruya:'ruya', tarot:'tarot', kahve:'kahve', yildiz:'yildiz', kocluk:'kocluk'}, '');
        $('#priority').value = map(priorityQS, {genel:'genel', is:'is', iliski:'iliski', saglik:'saglik'}, 'genel');
      } catch (err) {
        $('#noteErr').textContent = `İletim hatası: ${err?.message || err}`;
        $('#noteErr').style.display = 'block';
      }
    });
  </script>
</body>
</html>
